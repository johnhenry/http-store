<!doctype html>
<html>
    <head>
        <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>

        <!-- Web Component Polyfill for old browsers -->
        <script src="https://www.polymer-project.org/platform.js"></script>
        <!-- Release candidate of next React -->
        <script src="http://fb.me/react-with-addons-0.12.0-rc1.js"></script>
        <script src="http://fb.me/JSXTransformer-0.12.0-rc1.js"></script>
        <!-- Import a web component -->
        <link rel="import" href="https://www.polymer-project.org/components/core-icons/core-icons.html">
    </head>
    <body>
        <h1>Chat Plus</h1>
        <h2>Rhobust real-time Chat Application</h2>
        <p>
            This application is similar to the <a href="chat.html" >original chat application</a> but features a more rhobust feature set including:
            <ul>
                <li>Automatic Reconnection</li>
            </ul>
        </p>
        <hr />
        <div id='messagesDiv'></div>
        <span id='name'>:)</span>
        <input type='text' id='messageInput' placeholder='Message'>
        <br />
        <div id="react-root"></div>
        <script type="text/jsx">
          var coreIcon = React.createElement('core-icon', {src: '//www.polymer-project.org/images/icons/android.svg'});
          React.render(coreIcon, document.getElementById('react-root'))
        </script>
        <script>
        var name = String(Math.random()).substr(2);
        $('#name').html(name);
        var chatroom = "chatroom";
        var host =
        "ws://" +
        location.hostname
        + ((location.port !== 80 && location.port) ? ":" + location.port : "")
        + "/" + chatroom//key
        + "?listen=true&peek=true";//attributes
        var myDataRef;
        var reconnectInterval = 1000;
        var connect = function(){
            myDataRef = new WebSocket(host);
            $('#messageInput').keypress(function (e) {
                if (e.keyCode == 13) {//Enter Key
                    var text = $('#messageInput').val();
                    myDataRef.send("enqueue " + JSON.stringify({name: name, text: text}));
                    $('#messageInput').val('');
                }
            });
            myDataRef.onmessage = function(message){
                if(message.data){//New Data Incoming
                    message = JSON.parse(message.data);
                    displayChatMessage(message.name, message.text);
                }else{//New Data Available
                    myDataRef.send("pop");
                }
            }
            myDataRef.onclose = myDataRef.onerror = function() {
                setTimeout(connect, reconnectInterval);
            };
        };
        connect();
        var displayChatMessage = function(name, text) {
            $('<div/>').text(text).prepend($('<em/>').text(name+': ')).appendTo($('#messagesDiv'));
            $('#messagesDiv')[0].scrollTop = $('#messagesDiv')[0].scrollHeight;
        };
        </script>
    </body>
</html>
